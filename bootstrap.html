<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bootstrap - When To Leave</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href="manifest.json">

    <!--online resources-->
    <!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script-->
    <!--offline resources-->
    <link rel="stylesheet" href="offline/bootstrap.css">
    <script src="offline/jquery-3.1.1.js"></script>
    <script src="offline/bootstrap.js"></script>

    <link rel="stylesheet" href="styles/wtl.css">
  </head>
  <body>
    <div class="container" hidden>
      <div class="page-header">
        <h1>When To Leave</h1>
      </div>
      <div class="jumbotron">
        <!--h1>When To Leave</h1-->
        <p>You're working away - you're busy. Having to check transport timetables and then constantly keep an eye
          on the clock of when it's time to leave is too much of a distraction. Be notified when it's time to leave.</p>
      </div>
      <div class="wtlInputForm">
        <div class="form-group input-selection mode">
          <label for="modes">Transport mode:</label>
          <select class="form-control" id="modes">
            <option selected disabled value="">--select mode of transportation--</option>
            <option value="2">Bus</option>
            <option value="0">Train</option>
            <option value="1">Tram</option>
          </select>
        </div>

        <div class="form-group input-selection linesSelection"></div>

        <div class="form-group input-selection stopsSelection"></div>

        <div id="times-div" hidden>
          Between which times do you want to be notified?
          <div class="row">
            <div class="col-xs-6 col-sm-3">
              <div class="form-inline timesSelection">
                <label for="startTime">Start Time:</label>
                <select class="form-control form-time" id="startTime" onchange="setEndTime(this);">
                  <option selected disabled value="">select time</option><option value="0:00:00">12:00 AM</option><option value="0:15:00">12:15 AM</option><option value="0:30:00">12:30 AM</option><option value="0:45:00">12:45 AM</option><option value="1:00:00">1:00 AM</option><option value="1:15:00">1:15 AM</option><option value="1:30:00">1:30 AM</option><option value="1:45:00">1:45 AM</option><option value="2:00:00">2:00 AM</option><option value="2:15:00">2:15 AM</option><option value="2:30:00">2:30 AM</option><option value="2:45:00">2:45 AM</option><option value="3:00:00">3:00 AM</option><option value="3:15:00">3:15 AM</option><option value="3:30:00">3:30 AM</option><option value="3:45:00">3:45 AM</option><option value="4:00:00">4:00 AM</option><option value="4:15:00">4:15 AM</option><option value="4:30:00">4:30 AM</option><option value="4:45:00">4:45 AM</option><option value="5:00:00">5:00 AM</option><option value="5:15:00">5:15 AM</option><option value="5:30:00">5:30 AM</option><option value="5:45:00">5:45 AM</option><option value="6:00:00">6:00 AM</option><option value="6:15:00">6:15 AM</option><option value="6:30:00">6:30 AM</option><option value="6:45:00">6:45 AM</option><option value="7:00:00">7:00 AM</option><option value="7:15:00">7:15 AM</option><option value="7:30:00">7:30 AM</option><option value="7:45:00">7:45 AM</option><option value="8:00:00">8:00 AM</option><option value="8:15:00">8:15 AM</option><option value="8:30:00">8:30 AM</option><option value="8:45:00">8:45 AM</option><option value="9:00:00">9:00 AM</option><option value="9:15:00">9:15 AM</option><option value="9:30:00">9:30 AM</option><option value="9:45:00">9:45 AM</option><option value="10:00:00">10:00 AM</option><option value="10:15:00">10:15 AM</option><option value="10:30:00">10:30 AM</option><option value="10:45:00">10:45 AM</option><option value="11:00:00">11:00 AM</option><option value="11:15:00">11:15 AM</option><option value="11:30:00">11:30 AM</option><option value="11:45:00">11:45 AM</option><option value="12:00:00">12:00 PM</option><option value="12:15:00">12:15 PM</option><option value="12:30:00">12:30 PM</option><option value="12:45:00">12:45 PM</option><option value="13:00:00">1:00 PM</option><option value="13:15:00">1:15 PM</option><option value="13:30:00">1:30 PM</option><option value="13:45:00">1:45 PM</option><option value="14:00:00">2:00 PM</option><option value="14:15:00">2:15 PM</option><option value="14:30:00">2:30 PM</option><option value="14:45:00">2:45 PM</option><option value="15:00:00">3:00 PM</option><option value="15:15:00">3:15 PM</option><option value="15:30:00">3:30 PM</option><option value="15:45:00">3:45 PM</option><option value="16:00:00">4:00 PM</option><option value="16:15:00">4:15 PM</option><option value="16:30:00">4:30 PM</option><option value="16:45:00">4:45 PM</option><option value="17:00:00">5:00 PM</option><option value="17:15:00">5:15 PM</option><option value="17:30:00">5:30 PM</option><option value="17:45:00">5:45 PM</option><option value="18:00:00">6:00 PM</option><option value="18:15:00">6:15 PM</option><option value="18:30:00">6:30 PM</option><option value="18:45:00">6:45 PM</option><option value="19:00:00">7:00 PM</option><option value="19:15:00">7:15 PM</option><option value="19:30:00">7:30 PM</option><option value="19:45:00">7:45 PM</option><option value="20:00:00">8:00 PM</option><option value="20:15:00">8:15 PM</option><option value="20:30:00">8:30 PM</option><option value="20:45:00">8:45 PM</option><option value="21:00:00">9:00 PM</option><option value="21:15:00">9:15 PM</option><option value="21:30:00">9:30 PM</option><option value="21:45:00">9:45 PM</option><option value="22:00:00">10:00 PM</option><option value="22:15:00">10:15 PM</option><option value="22:30:00">10:30 PM</option><option value="22:45:00">10:45 PM</option><option value="23:00:00">11:00 PM</option><option value="23:15:00">11:15 PM</option><option value="23:30:00">11:30 PM</option><option value="23:45:00">11:45 PM</option>
                </select>
              </div>
            </div>
            <div class="col-xs-6 col-sm-3">
              <div class="form-inline timesSelection">
                <label for="endTime">End Time:</label>
                <select class="form-control form-time" id="endTime">
                  <option selected disabled value="">select time</option><option value="0:00:00">12:00 AM</option><option value="0:15:00">12:15 AM</option><option value="0:30:00">12:30 AM</option><option value="0:45:00">12:45 AM</option><option value="1:00:00">1:00 AM</option><option value="1:15:00">1:15 AM</option><option value="1:30:00">1:30 AM</option><option value="1:45:00">1:45 AM</option><option value="2:00:00">2:00 AM</option><option value="2:15:00">2:15 AM</option><option value="2:30:00">2:30 AM</option><option value="2:45:00">2:45 AM</option><option value="3:00:00">3:00 AM</option><option value="3:15:00">3:15 AM</option><option value="3:30:00">3:30 AM</option><option value="3:45:00">3:45 AM</option><option value="4:00:00">4:00 AM</option><option value="4:15:00">4:15 AM</option><option value="4:30:00">4:30 AM</option><option value="4:45:00">4:45 AM</option><option value="5:00:00">5:00 AM</option><option value="5:15:00">5:15 AM</option><option value="5:30:00">5:30 AM</option><option value="5:45:00">5:45 AM</option><option value="6:00:00">6:00 AM</option><option value="6:15:00">6:15 AM</option><option value="6:30:00">6:30 AM</option><option value="6:45:00">6:45 AM</option><option value="7:00:00">7:00 AM</option><option value="7:15:00">7:15 AM</option><option value="7:30:00">7:30 AM</option><option value="7:45:00">7:45 AM</option><option value="8:00:00">8:00 AM</option><option value="8:15:00">8:15 AM</option><option value="8:30:00">8:30 AM</option><option value="8:45:00">8:45 AM</option><option value="9:00:00">9:00 AM</option><option value="9:15:00">9:15 AM</option><option value="9:30:00">9:30 AM</option><option value="9:45:00">9:45 AM</option><option value="10:00:00">10:00 AM</option><option value="10:15:00">10:15 AM</option><option value="10:30:00">10:30 AM</option><option value="10:45:00">10:45 AM</option><option value="11:00:00">11:00 AM</option><option value="11:15:00">11:15 AM</option><option value="11:30:00">11:30 AM</option><option value="11:45:00">11:45 AM</option><option value="12:00:00">12:00 PM</option><option value="12:15:00">12:15 PM</option><option value="12:30:00">12:30 PM</option><option value="12:45:00">12:45 PM</option><option value="13:00:00">1:00 PM</option><option value="13:15:00">1:15 PM</option><option value="13:30:00">1:30 PM</option><option value="13:45:00">1:45 PM</option><option value="14:00:00">2:00 PM</option><option value="14:15:00">2:15 PM</option><option value="14:30:00">2:30 PM</option><option value="14:45:00">2:45 PM</option><option value="15:00:00">3:00 PM</option><option value="15:15:00">3:15 PM</option><option value="15:30:00">3:30 PM</option><option value="15:45:00">3:45 PM</option><option value="16:00:00">4:00 PM</option><option value="16:15:00">4:15 PM</option><option value="16:30:00">4:30 PM</option><option value="16:45:00">4:45 PM</option><option value="17:00:00">5:00 PM</option><option value="17:15:00">5:15 PM</option><option value="17:30:00">5:30 PM</option><option value="17:45:00">5:45 PM</option><option value="18:00:00">6:00 PM</option><option value="18:15:00">6:15 PM</option><option value="18:30:00">6:30 PM</option><option value="18:45:00">6:45 PM</option><option value="19:00:00">7:00 PM</option><option value="19:15:00">7:15 PM</option><option value="19:30:00">7:30 PM</option><option value="19:45:00">7:45 PM</option><option value="20:00:00">8:00 PM</option><option value="20:15:00">8:15 PM</option><option value="20:30:00">8:30 PM</option><option value="20:45:00">8:45 PM</option><option value="21:00:00">9:00 PM</option><option value="21:15:00">9:15 PM</option><option value="21:30:00">9:30 PM</option><option value="21:45:00">9:45 PM</option><option value="22:00:00">10:00 PM</option><option value="22:15:00">10:15 PM</option><option value="22:30:00">10:30 PM</option><option value="22:45:00">10:45 PM</option><option value="23:00:00">11:00 PM</option><option value="23:15:00">11:15 PM</option><option value="23:30:00">11:30 PM</option><option value="23:45:00">11:45 PM</option>
                </select>
              </div>
            </div>
            <div class="col-sm-3"></div>
            <div class="col-sm-3"></div>
          </div>
          <div class="form-inline minutesAway-div">
            <label data-toggle="tooltip" title="This acts as a buffer: it's how many minutes before arrival time you'll be notfied to leave" for="minutesAway">How long does it take you to walk to the stop?</label>
            <input type="text" id="minutesAway" class="form-control" value="10"/>
          </div>
          <div class="submitButtonRow">
            <button type="submit" id="submitFormButton" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </div>

      <!-- alerts -->
      <div id="alertSection">
        <div class="alert alert-success fade in" hidden>
          <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
          <strong>Success!</strong> Indicates a successful or positive action.
        </div>

        <div class="alert alert-info" hidden>
          <strong>Info!</strong> Indicates a neutral informative change or action.
        </div>

        <div class="alert alert-warning" hidden>
          <strong>Warning!</strong> Indicates a warning that might need attention.
        </div>

        <div class="alert alert-danger" hidden>
          <strong>Danger!</strong> Indicates a dangerous or potentially negative action.
        </div>
      </div>


<button type="button" class="btn btn-info" onclick="sendTestNotification()">Send Test Notification</button>
      <!-- rows and columns -->


      <div id="savedNotifications"></div>



      <div class="row">
        <div class="col-sm-4 lightblue">.col-sm-4</div>
        <div class="col-sm-4 gray">.col-sm-4</div>
        <div class="col-sm-4 lightgreen">.col-sm-4</div>
      </div>

      <div class="row">
        <div class="col-sm-2 lightblue">.col-sm-2</div>
        <div class="col-sm-2 gray">.col-sm-2</div>
        <div class="col-sm-2 lightgreen">.col-sm-2</div>
        <div class="col-sm-2 lightblue">.col-sm-2</div>
        <div class="col-sm-2 gray">.col-sm-2</div>
        <div class="col-sm-2 lightgreen">.col-sm-2</div>
      </div>
      <div class="row">
        <div class="col-xs-4 lightblue">.col-xs-4</div>
        <div class="col-xs-4 gray">.col-xs-4</div>
        <div class="col-xs-4 lightgreen">.col-xs-4</div>
      </div>
      <div class="row">
        <div class="col-xs-6 lightblue">.col-xs-6</div>
        <div class="col-xs-6 gray">.col-xs-6</div>
      </div>
      <div class="row">
        <div class="col-xs-11 col-md-11 lightblue">.col-xs-11</div>
        <div class="col-xs-1 col-md-1 gray">.col-xs-6</div>
      </div>




      <!-- dropdown -->
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Dropdown Example
        <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li><a href="#">HTML</a></li>
          <li><a href="#">CSS</a></li>
          <li><a href="#">JavaScript</a></li>
          <li class="divider"></li>
          <li class="disabled"><a href="#">About Us</a></li>
        </ul>
      </div>

      <div class="well">Basic Well</div>

      <button type="button" class="btn btn-default">Default</button>
      <button type="button" class="btn btn-primary">Primary</button>
      <button type="button" class="btn btn-success">Success</button>
      <button type="button" class="btn btn-info">Info</button>
      <button type="button" class="btn btn-warning">Warning</button>
      <button type="button" class="btn btn-danger">Danger</button>
      <button type="button" class="btn btn-link">Link</button>

      <div class="well">Basic Well</div>

      <div class="page-footer">
        <p>Test footer</p>
      </div>
    </div>

    <div class="loader">
      <svg viewBox="0 0 32 32" width="32" height="32">
        <circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
      </svg>
    </div>
    <script type="text/javascript">
      "use strict";

      var app = {
        //isLoading: true,
        //visibleCards: {},
        //selectedCities: []
        wtlSubscriberId: '',
        wtlSubscriberStatus: false,
        wtlSelectedNotifications: []
        //spinner: document.querySelector('.loader'),
        //cardTemplate: document.querySelector('.cardTemplate'),
        //container: document.querySelector('.main'),
        //addDialog: document.querySelector('.dialog-container'),
        //daysOfWeek: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
      };

      //init stuff, should probably go in a proper onready thingamajig
      document.querySelector('.container').removeAttribute('hidden');
      document.querySelector('.loader').setAttribute('hidden', true);


      //global variable, available inside all functions
      var modes = document.getElementById('modes');

      modes.addEventListener("change", function() {
        //display the loading spinner
        document.querySelector('.loader').removeAttribute('hidden');

        //hide the 'stops' dropdown if it exists
        if(document.querySelector(".stopsSelection")){
          document.querySelector(".stopsSelection").setAttribute('hidden', true);
        }
        //hide the 'times-div' div if it exists
        if(document.getElementById('times-div')){
          document.getElementById('times-div').setAttribute('hidden', true);
        }

        //getLines(modes.value);
        var url = 'get_lines.php?mode=' + modes.value;
        //TODO: fetch to be replaced by function above once caches and service worker is set up
        fetch(url).then(function(response){
          return response.json().then(function(data){

            if(data.error_message){
              console.log('error message json value: ' + data.error_message);
              showError(data.error_message);
            }else{
              //sort in alphabetical order
              data = sortByKey(data, 'line_name');

              //Create and append select list, but check if exists first
              var selectList;
              if(document.getElementById('lines')){
                selectList = document.getElementById('lines');
                selectList.removeAttribute('hidden');
                clearSelect(selectList);
              }else{
                var linesDiv = document.querySelector(".linesSelection");
                var labelFor = document.createElement("label");
                labelFor.htmlFor = "lines";
                labelFor.innerHTML = "Line/Route TODO trains at least will need a direction...";
                linesDiv.appendChild(labelFor);
                selectList = document.createElement("select");
                selectList.id = "lines";
                selectList.className = "form-control";
                selectList.onchange = function(){getStops(this)};
                linesDiv.appendChild(selectList);
              }


              //Create and append the options - start with initial blank
              var initialOption = document.createElement("option");
              initialOption.value = "";
              initialOption.text = "select line";
              initialOption.disabled = true;
              initialOption.selected = true;
              selectList.appendChild(initialOption);
              for (var i = 0; i < data.length; i++) {
                var option = document.createElement("option");
                option.value = data[i].line_id;
                option.text = data[i].line_name;
                selectList.appendChild(option);
              }
            }
          });
        }).then(function(){
          //remove loading spinner
          document.querySelector('.loader').setAttribute('hidden', true);
        });
      });

      function getStops(obj){
        //display the loading spinner
        document.querySelector('.loader').removeAttribute('hidden');

        var url = 'get_stops.php?mode=' + modes.value + '&line=' + obj.value;
        //TODO: fetch to be replaced by function above once caches and service worker is set up
        fetch(url).then(function(response){
          return response.json().then(function(data){
            if(data.error_message){
              console.log('error message json value: ' + data.error_message);
              showError(data.error_message);
            }else{
              //sort in alphabetical order
              data = sortByKey(data, 'line_name');


              //Create and append select list, but check if exists first
              var selectList;
              if(document.getElementById('stops')){
                selectList = document.getElementById('stops');
                selectList.removeAttribute('hidden');
                clearSelect(selectList);
                document.querySelector(".stopsSelection").removeAttribute('hidden');
              }else{
                var stopsDiv = document.querySelector(".stopsSelection");
                stopsDiv.removeAttribute('hidden');
                var labelFor = document.createElement("label");
                labelFor.htmlFor = "stops";
                labelFor.innerHTML = "Which stop?";
                stopsDiv.appendChild(labelFor);
                selectList = document.createElement("select");
                selectList.id = "stops";
                selectList.className = "form-control";
                selectList.onchange = function(){loadTimes();};
                stopsDiv.appendChild(selectList);
              }


              //Create and append the options - start with initial blank
              var initialOption = document.createElement("option");
              initialOption.value = "";
              initialOption.text = "select stop";
              initialOption.disabled = true;
              initialOption.selected = true;
              selectList.appendChild(initialOption);
              for (var i = 0; i < data.length; i++) {
                var option = document.createElement("option");
                option.value = data[i].stop_id;
                option.text = data[i].location_name;
                selectList.appendChild(option);
              }
            }
          });
        }).then(function(){
          //remove loading spinner
          document.querySelector('.loader').setAttribute('hidden', true);
        });;
      }

      function loadTimes(){
        var selectList;
        if(document.getElementById('times-div')){
          selectList = document.getElementById('times-div');
          selectList.removeAttribute('hidden');
        }else{
          var stopsDiv = document.querySelector(".timesSelection");
          selectList = document.createElement("select");
          selectList.id = "stops";
          selectList.onchange = function(){loadTimes();};
          stopsDiv.appendChild(selectList);
        }
      }

      function showError(errorMessage){
        var alertDanger = document.querySelector('.alert-danger');
        if(alertDanger){
          alertDanger.removeAttribute('hidden');
          alertDanger.innerHTML = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Error occurred: </strong>' + errorMessage;
        }else{
          var alertDanger = document.createElement("div");
          alertDanger.innerHTML = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Error occurred: </strong>' + errorMessage;
          document.getElementById("alertSection").appendChild(alertDanger);
        }
      }

      function showSuccessMessage(successMessage){
        var alertSuccess = document.querySelector('.alert-success');
        if(alertSuccess){
          alertSuccess.removeAttribute('hidden');
          alertSuccess.innerHTML = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Success: </strong>' + successMessage;
        }else{
          var alertSuccess = document.createElement("div");
          alertSuccess.innerHTML = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>Success: </strong>' + successMessage;
          alertSuccess.getElementById("alertSection").appendChild(alertSuccess);
        }
      }

      function clearSelect(selectName){
        while (selectName.options.length) {
          selectName.remove(0);
        }
      }

      function sortByKey(array, key) {
          return array.sort(function(a, b) {
              var x = a[key]; var y = b[key];
              return ((x < y) ? -1 : ((x > y) ? 1 : 0));
          });
      }
      function setEndTime(dropdown){
        //TODO need to put validation in here in case it's the last one
        document.getElementById('endTime').selectedIndex = dropdown.selectedIndex + 4;
      }


      //submit button stuff
      document.getElementById('submitFormButton').addEventListener('click', function() {
        // To use FORM SUBMIT, or NOT to use FORM SUBMIT...that is the question...let's NOT
        var modeDropdown = document.getElementById('modes');
        var lineDropdown = document.getElementById('lines');
        var stopDropdown = document.getElementById('stops');
        var startTimeDropdown = document.getElementById('startTime');
        var endTimeDropdown = document.getElementById('endTime');
        var minutesAwayValue = document.getElementById('minutesAway').value;

        var selectedMode = modeDropdown.options[modeDropdown.selectedIndex];
        var selectedLine = lineDropdown.options[lineDropdown.selectedIndex];
        var selectedStop = stopDropdown.options[stopDropdown.selectedIndex];
        var selectedStartTime = startTimeDropdown.options[startTimeDropdown.selectedIndex];
        var selectedEndTime = endTimeDropdown.options[endTimeDropdown.selectedIndex];

        var selectedModeValue = selectedMode.value;
        var selectedModeText = selectedMode.textContent;

        var selectedLineValue = selectedLine.value;
        var selectedLineText = selectedLine.textContent;

        var selectedStopValue = selectedStop.value;
        var selectedStopText = selectedStop.textContent;

        var selectedStartTimeValue = selectedStartTime.value;
        var selectedStartTimeText = selectedStartTime.textContent;

        var selectedEndTimeValue = selectedEndTime.value;
        var selectedEndTimeText = selectedEndTime.textContent;

        /*var selected = select.options[select.selectedIndex];
        var key = selected.value;
        var label = selected.textContent;*/
        if (!app.wtlSelectedNotifications) {
          app.wtlSelectedNotifications = [];
        }
        //app.getForecast(key, label);
        //get a unique key for this notification - so it can be deleted later
        var uniqueKey = new Date().valueOf();
        app.wtlSelectedNotifications.push({key: uniqueKey, modeValue: selectedModeValue, modeText: selectedModeText,
          lineValue: selectedLineValue, lineText: selectedLineText,
          stopValue: selectedStopValue, stopText: selectedStopText,
          startTimeValue: selectedStartTimeText, startTimeText: selectedStartTimeText,
          endTimeValue: selectedEndTimeValue, endTimeText: selectedEndTimeText,
          minutesAway: minutesAwayValue}
        );
        console.log('app.wtlSelectedNotifications.push was successful');
        app.saveWtlSelectedNotifications();
        console.log('app.wtlSelectedNotifications.push was successful');
        showSuccessMessage('Notification saved!');

        //if (!checkIfUserIsOptedIn()) {
        //no check - just subscribe and update the local storage values
        subscribe();
        //}

        //TODO need to load notifications so you can see your saved one immediately
      });

      app.saveWtlSelectedNotifications = function() {
        var wtlSelectedNotifications = JSON.stringify(app.wtlSelectedNotifications);
        console.log('wtlSelectedNotifications is: ' + wtlSelectedNotifications);
        localStorage.wtlSelectedNotifications = wtlSelectedNotifications;
      };

      //load from local storage
      app.wtlSubscriberId = localStorage.wtlSubscriberId;
      app.wtlSubscriberStatus = localStorage.wtlSubscriberStatus;

      app.wtlSelectedNotifications = localStorage.wtlSelectedNotifications;
      if (app.wtlSelectedNotifications) {
        app.wtlSelectedNotifications = JSON.parse(app.wtlSelectedNotifications);
        app.wtlSelectedNotifications.forEach(function(notification) {
          console.log('app.wtlSelectedNotifications loaded, notification.selectedLineText: ' + notification.lineText);
          //UP TO HERE
          var savedNotifications = document.getElementById("savedNotifications");
          var newRow = document.createElement("div")
          newRow.className = "row";
          newRow.id = notification.key;

          var newColumn = document.createElement("div");
          newColumn.className = "col-xs-11 col-md-11 lightblue";
          newColumn.innerHTML = "Test: " + notification.lineText;

          newRow.appendChild(newColumn);

          var deleteButtonColumn = document.createElement("div");
          deleteButtonColumn.className = "col-xs-1 col-md-1 gray";
          deleteButtonColumn.innerHTML = '<button type="button" class="btn btn-link" onclick="deleteNotification(\'' + notification.key + '\');">Delete</button>';
          newRow.appendChild(deleteButtonColumn);

          savedNotifications.appendChild(newRow);


          //savedNotifications.appendChild(newColumn);

          //TODO write a 'getNotifications' function to display at ht ebottom of the page in a "Current notifications" setup, then add delete button etc.
          //app.getForecast(city.key, city.label);
        });
      } else {
        // The user is using the app for the first time, or the user has not saved any cities, so show the user some fake data.
        console.log('Using the app for the first time');
        //no need to load defaults...commenting out
        /*app.updateForecastCard(initialWeatherForecast);
        app.selectedCities = [
          {key: initialWeatherForecast.key, label: initialWeatherForecast.label}
        ];
        app.saveSelectedCities();*/
      }

      function deleteNotification(key){
        //delete the notification from local storage and remove the div
        //Step 1, delete it from app.wtlSelectedNotifications
        for(var i = 0; i < app.wtlSelectedNotifications.length; i++){
          console.log('deleteNotification, i: ' + i + ', key: ' + key);
          if(app.wtlSelectedNotifications[i].key == key){
            app.wtlSelectedNotifications.splice(i, 1);
            break;
          }
        }
        //Step 2, stringify, and save the updated app.wtlSelectedNotifications to localStorage
        var wtlSelectedNotifications = JSON.stringify(app.wtlSelectedNotifications);
        console.log('wtlSelectedNotifications is: ' + wtlSelectedNotifications);
        localStorage.wtlSelectedNotifications = wtlSelectedNotifications;
        //Step 3, remove the div
        var divToDelete = document.getElementById(key);
        divToDelete.remove();
      }

      //function to check if user is opted-in and return true or false
      function checkIfUserIsOptedIn(){
        app.wtlSubscriberId = localStorage.wtlSubscriberId;
        app.wtlSubscriberStatus = localStorage.wtlSubscriberStatus;
        if(app.wtlSubscriberId && app.wtlSubscriberStatus){
          return true;
        }else{
          return false;
        }
      }



      //subscribe and send stuff
      var reg;
      var sub;
      var isSubscribed = false;
      var subscribeButton = document.getElementById('subscribeButton');

      if ('serviceWorker' in navigator) {
        console.log('Service Worker is supported');
        navigator.serviceWorker.register('wtl-service-worker.js').then(function() {
          return navigator.serviceWorker.ready;
        }).then(function(serviceWorkerRegistration) {
          reg = serviceWorkerRegistration;
          //subscribeButton.disabled = false;
          console.log('Service Worker is ready :^)', reg);
        }).catch(function(error) {
          console.log('Service Worker Error :^(', error);
        });
      }

      function subscribe() {
        reg.pushManager.subscribe({userVisibleOnly: true}).
        then(function(pushSubscription){
          sub = pushSubscription;
          console.log('Subscribed! Endpoint:', sub.endpoint);

          //CC Custom Code:
          //start send endpoint to php for saving
          $.post("save_gcm.php", {data: sub.endpoint}, function(response){
            console.log("response: " + response);
          });
          //end send endpoint to php for saving

          isSubscribed = true;

          //save into localstorage

          if (!app.wtlSubscriberId) {
            app.wtlSubscriberId = '';
          }
          if(sub.endpoint.indexOf("https://android.googleapis.com/gcm/send/") == 0){
            app.wtlSubscriberId = sub.endpoint.substring(40);
            //save into local storage
            localStorage.wtlSubscriberId = app.wtlSubscriberId;
            localStorage.wtlSubscriberStatus = true;
            console.log('app.wtlSubscriberId successfully saved into localstorage and set to ' + app.wtlSubscriberId);
          }
        });
      }

      function unsubscribe() {
        sub.unsubscribe().then(function(event) {
//TODO update localstorage

          subscribeButton.textContent = 'Subscribe';
          console.log('Unsubscribed!', event);
          isSubscribed = false;
        }).catch(function(error) {
          console.log('Error unsubscribing', error);
          subscribeButton.textContent = 'Subscribe';
        });
      }

      function checkDeparture(){
      	//second parameter , {} is missing - this could be some variable
      	//NO, WE NEED TO COMPLETELY SEPARATE OUT THE SEND PART, SO THAT THIS CAN BE CALLED IN THE SERVICE WORKER, AND THE RESPONSE PASSED IN AS THE PAYLOAD FOR TITLE AND BODY
      	$.post("ptv_check_and_send.php", function(response){
              console.log("response: " + response);
              document.getElementById("minsaway").innerHTML = 'Next bus is ' + response + ' minutes away';
          });
      }



      function sendTestNotification(){
      	//second parameter , {} is missing - this could be some variable
      	//NO, WE NEED TO COMPLETELY SEPARATE OUT THE SEND PART, SO THAT THIS CAN BE CALLED IN THE SERVICE WORKER, AND THE RESPONSE PASSED IN AS THE PAYLOAD FOR TITLE AND BODY
        console.log('app.wtlSubscriberId is: ' + app.wtlSubscriberId);
      	$.post("ptv_check_and_send.php?subscriberId=" + app.wtlSubscriberId, function(response){
            console.log("response: " + response);
              //document.getElementById("minsaway").innerHTML = 'Next bus is ' + response + ' minutes away';
          });
      }
      //https://android.googleapis.com/gcm/send/fU6zFIuQQDU:APA91bEN9sbfvqQb-5T3RCrwEePTlc7269BywDw89lbbkKrk7KgKFmjkmKqPDQdWadi5YKJ4YJseIclpI2I0pCf3OArQXIHB5n_fs1MuASoQFtye1aKCkiqPYy3I8fWwXJtzMNW6xjuC



/*$("#non-dynamic-ancestor-of-message").on("click", "#message", function() {
    console.log("clicked");
});*/
/*

      var lines = document.getElementById('lines');
      lines.addEventListener("change", function() {
        console.log(modes.value);
        //getLines(modes.value);
        var url = 'get_lines.php?mode=' + modes.value;
        //TODO: fetch to be replaced by function above once caches and service worker is set up
        fetch(url)
        .then(function(response){
          return response.json().then(function(data){
            console.log(data);
            //sort in alphabetical order
            data = sortByKey(data, 'line_name');


            //Create and append select list
            var linesDiv = document.querySelector(".linesSelection");
            var selectList = document.createElement("select");
            selectList.id = "lines";
            linesDiv.appendChild(selectList);

            //Create and append the options
            for (var i = 0; i < data.length; i++) {
              var option = document.createElement("option");
              option.value = data[i].line_id;
              option.text = data[i].line_name;
              selectList.appendChild(option);
            }



          });
        });

      });

*/


      //NOT USED - but come back to later for cache logic
      /*
      function getLines(mode) {
        var url = 'get_lines.php?mode=' + mode;
        // TODO add cache logic here
        if ('caches' in window) {
          //Check if the service worker has already cached this city's weather data. If the service worker has the data, then display the cached data while the app fetches the latest data.

          caches.match(url).then(function(response) {
            if (response) {
              response.json().then(function updateFromCache(json) {
                var results = json.query.results;
                results.key = key;
                results.label = label;
                results.created = json.query.created;
                app.updateForecastCard(results);
              });
            }
          });
        }

        // Fetch the latest data.
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
          if (request.readyState === XMLHttpRequest.DONE) {
            if (request.status === 200) {
              console.log('Data was available, getting latest');
              var response = JSON.parse(request.response);
              console.log(response);
              //var results = response.query.results;
              //do something with the results - update the select
              //app.updateForecastCard(results);
            }
          } else {
            // Return the initial weather forecast since no data is available.
            console.log('No data available, returning initial');
            //do something if fails...not this:
            //app.updateForecastCard(initialWeatherForecast);
          }
        };
        request.open('GET', url);
        request.send();
      };*/

    </script>

    <!--script src="scripts/app.js" async></script-->
    <script type="text/javascript">
      $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip();
      });
    </script>

  </body>
</html>
